{{- $styles := resources.Get "css/common.css" | minify | fingerprint -}}
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ .Title }} | No Money to Cultivate Immortality</title>
        <meta name="description" content="{{ .Description }}" />
        <meta name="author" content="{{ .Params.translator | default `` }}" />
        <meta name="robots" content="index, follow" />
        <link rel="canonical" href="{{ .Permalink }}" />
        <meta name="theme-color" content="#333333" />

        <link
            rel="icon"
            type="image/png"
            href="{{ `icons/favicon-96x96.png` | relURL }}"
            sizes="96x96"
        />
        <link
            rel="icon"
            type="image/svg+xml"
            href="{{ `assets/icons/favicon.svg` | relURL }}"
        />
        <link rel="shortcut icon" href="{{ `icons/favicon.ico` | relURL }}" />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{{ `icons/apple-touch-icon.png` | relURL }}"
        />
        <meta
            name="apple-mobile-web-app-title"
            content="{{ .Params.short_name | default .Title }}"
        />
        {{ with .OutputFormats.Get "WebAppManifest" }}
        <link rel="manifest" href="{{ .Permalink }}" />
        {{ end }}
        <meta property="og:type" content="book" />
        <meta property="og:url" content="{{ .Permalink }}" />
        <meta property="og:title" content="{{ .Title }}" />
        <meta property="og:description" content="{{ .Description }}" />
        {{ with .Params.images }}
        <meta property="og:image" content="{{ index . 0 | relURL }}" />
        {{ end }}

        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content="{{ .Permalink }}" />
        <meta property="twitter:title" content="{{ .Title }}" />
        <meta property="twitter:description" content="{{ .Description }}" />
        {{ with .Params.images }}
        <meta property="twitter:image" content="{{ index . 0 | relURL }}" />
        {{ end }}

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Baskervville:ital@0;1&family=Bitter:ital,wght@0,100..900;1,100..900&family=Caveat:wght@400..700&family=Coming+Soon&family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Fira+Mono:wght@400;500;700&family=Indie+Flower&family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&family=Merriweather:ital,wght@0,300..900;1,300..900&family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Patrick+Hand&display=swap"
            rel="stylesheet"
            media="print"
            onload="this.media = 'all'"
        />
        <noscript>
            <link
                href="https://fonts.googleapis.com/css2?family=Baskervville:ital@0;1&family=Bitter:ital,wght@0,100..900;1,100..900&family=Caveat:wght@400..700&family=Coming+Soon&family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Fira+Mono:wght@400;500;700&family=Indie+Flower&family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&family=Merriweather:ital,wght@0,300..900;1,300..900&family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Patrick+Hand&display=swap"
                rel="stylesheet"
            />
        </noscript>

        <link rel="stylesheet" href="{{ $styles.RelPermalink }}" />

        <script>
            try {
                const saved = localStorage.getItem("reader-settings");
                if (saved) {
                    const theme = JSON.parse(saved).theme || "light";
                    const themes = {
                        light: { bg: "#fdfdfd", text: "#333333" },
                        sepia: { bg: "#f4ecd8", text: "#5b4636" },
                        dark: { bg: "#222222", text: "#d1d1d1" },
                        midnight: { bg: "#2b323b", text: "#c4cdd5" },
                        forest: { bg: "#e8f5e9", text: "#2d3b2d" },
                        amoled: { bg: "#000000", text: "#b3b3b3" },
                    };
                    const t = themes[theme] || themes.light;
                    document.documentElement.style.setProperty(
                        "--bg-color",
                        t.bg,
                    );
                    document.documentElement.style.setProperty(
                        "--text-color",
                        t.text,
                    );
                }
            } catch (e) {}
        </script>
    </head>

    <body>
        {{ .Content }}
    </body>

    <script>
        const CONFIG = {
            storageKeys: {
                settings: "reader-settings",
            },
            themes: {
                light: { bg: "#fdfdfd", text: "#333333" },
                sepia: { bg: "#f4ecd8", text: "#5b4636" },
                dark: { bg: "#222222", text: "#d1d1d1" },
                midnight: { bg: "#2b323b", text: "#c4cdd5" },
                forest: { bg: "#e8f5e9", text: "#2d3b2d" },
                amoled: { bg: "#000000", text: "#b3b3b3" },
            },
        };

        const DOM = {
            root: document.documentElement,
        };

        const ThemeManager = {
            init() {
                this.load();
            },

            apply(themeName) {
                const theme = CONFIG.themes[themeName] || CONFIG.themes.light;
                DOM.root.style.setProperty("--bg-color", theme.bg);
                DOM.root.style.setProperty("--text-color", theme.text);
                DOM.root.setAttribute("data-theme", themeName);
                const metaThemeColor = document.querySelector(
                    'meta[name="theme-color"]',
                );
                if (metaThemeColor)
                    metaThemeColor.setAttribute("content", theme.bg);
                DOM.themeBtns.forEach((btn) => {
                    if (btn.dataset.theme === themeName) {
                        btn.classList.add("active");
                    } else {
                        btn.classList.remove("active");
                    }
                });
            },
            load() {
                const savedSettings = localStorage.getItem(
                    CONFIG.storageKeys.settings,
                );
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    if (settings.fontFamily) {
                        DOM.root.style.setProperty(
                            "--font-family",
                            settings.fontFamily,
                        );
                    }
                    this.apply(settings.theme || "light");
                } else {
                    this.apply("light");
                }
            },
        };

        ThemeManager.init();
    </script>
</html>
